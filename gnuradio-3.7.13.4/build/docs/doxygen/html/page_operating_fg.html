<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.6"/>
<title>GNU Radio Manual and C++ API Reference: Handling flow graphs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="gnuradio_logo_icon.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">GNU Radio Manual and C++ API Reference
   &#160;<span id="projectnumber">3.7.13.4</span>
   </div>
   <div id="projectbrief">The Free &amp; Open Software Radio Ecosystem</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_operating_fg.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(13)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Handling flow graphs </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="flowgraph"></a>
Operating a Flowgraph</h1>
<p>The basic data structure in GNU Radio is the flowgraph, which represents the connections of the blocks through which a continuous stream of samples flows. The concept of a flowgraph is an acyclic directional graph with one or more source blocks (to insert samples into the flowgraph), one or more sink blocks (to terminate or export samples from the flowgraph), and any signal processing blocks in between.</p>
<p>A program must at least create a GNU Radio 'top_block', which represents the top-most structure of the flowgraph. The top blocks provide the overall control and hold methods such as 'start,' 'stop,' and 'wait'.</p>
<p>The general construction of a GNU Radio application is to create a gr_top_block, instantiate the blocks, connect the blocks together, and then start the gr_top_block. The following program shows how this is done. A single source and sink are used with a FIR filter between them.</p>
<div class="fragment"><div class="line">from gnuradio <span class="keyword">import</span> gr, blocks, filter, analog</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>my_topblock(gr.top_block):</div>
<div class="line">    def __init__(self):</div>
<div class="line">        gr.top_block.__init__(self)</div>
<div class="line"></div>
<div class="line">        amp = 1</div>
<div class="line">        <a class="code" href="interpolator__taps_8h.html#a30bf032e13c2a9fc4a98e14e390cd65a">taps</a> = filter.firdes.low_pass(1, 1, 0.1, 0.01)</div>
<div class="line"></div>
<div class="line">        self.src = analog.noise_source_c(analog.GR_GAUSSIAN, amp)</div>
<div class="line">        self.flt = filter.fir_filter_ccf(1, taps)</div>
<div class="line">        self.snk = blocks.null_sink(gr.sizeof_gr_complex)</div>
<div class="line"></div>
<div class="line">        self.connect(self.src, self.flt, self.snk)</div>
<div class="line"></div>
<div class="line">if __name__ == &quot;__main__&quot;:</div>
<div class="line">    tb = my_topblock()</div>
<div class="line">    tb.start()</div>
<div class="line">    tb.wait()</div>
</div><!-- fragment --><p>The 'tb.start()' starts the data flowing through the flowgraph while the 'tb.wait()' is the equivalent of a thread's 'join' operation and blocks until the gr_top_block is done.</p>
<p>An alternative to using the 'start' and 'wait' methods, a 'run' method is also provided for convenience that is a blocking start call; equivalent to the above 'start' followed by a 'wait.'</p>
<h2><a class="anchor" id="latency"></a>
Latency and Throughput</h2>
<p>By default, GNU Radio runs a scheduler that attempts to optimize throughput. Using a dynamic scheduler, blocks in a flowgraph pass chunks of items from sources to sinks. The sizes of these chunks will vary depending on the speed of processing. For each block, the number of items it can process is dependent on how much space it has in its output buffer(s) and how many items are available on the input buffer(s).</p>
<p>The consequence of this is that often a block may be called with a very large number of items to process (several thousand). In terms of speed, this is efficient since now the majority of the processing time is taken up with processing samples. Smaller chunks mean more calls into the scheduler to retrieve more data. The downside to this is that it can lead to large latency while a block is processing a large chunk of data.</p>
<p>To combat this problem, the gr_top_block can be passed a limit on the number of output items a block will ever receive. A block may get less than this number, but never more, and so it serves as an upper limit to the latency any block will exhibit. By limiting the number of items per call to a block, though, we increase the overhead of the scheduler, and so reduce the overall efficiency of the application.</p>
<p>To set the maximum number of output items, we pass a value into the 'start' or 'run' method of the gr_top_block:</p>
<div class="fragment"><div class="line">     tb.start(1000)</div>
<div class="line">     tb.wait()</div>
<div class="line">or</div>
<div class="line">     tb.run(1000)</div>
</div><!-- fragment --><p>Using this method, we place a global restriction on the size of items to all blocks. Each block, though, has the ability to overwrite this with its own limit. Using the 'set_max_noutput_items(m)' method for an individual block will overwrite the global setting. For example, in the following code, the global setting is 1000 items max, except for the FIR filter, which can receive up to 2000 items.</p>
<div class="fragment"><div class="line">tb.flt.set_max_noutput_items(2000)</div>
<div class="line">tb.run(1000)</div>
</div><!-- fragment --><p>In some situations, you might actually want to restrict the size of the buffer itself. This can help to prevent a buffer who is blocked for data from just increasing the amount of items in its buffer, which will then cause an increased latency for new samples. You can set the size of an output buffer for each output port for every block.</p>
<p>WARNING: This is an advanced feature in GNU Radio and should not be used without a full understanding of this concept as explained below.</p>
<p>To set the output buffer size of a block, you simply call:</p>
<div class="fragment"><div class="line">tb.blk0.set_max_output_buffer(2000)</div>
<div class="line">tb.blk1.set_max_output_buffer(1, 2000)</div>
<div class="line">tb.start()</div>
<div class="line"><a class="code" href="namespacepmt.html#acf4beefce8c6c5c70bdce4e246a54886">print</a> tb.blk1.max_output_buffer(0)</div>
<div class="line"><a class="code" href="namespacepmt.html#acf4beefce8c6c5c70bdce4e246a54886">print</a> tb.blk1.max_output_buffer(1)</div>
</div><!-- fragment --><p>In the above example, all ports of blk0 are set to a buffer size of 2000 in <em>items</em> (not bytes), and blk1 only sets the size for output port 1, any and all other ports use the default. The third and fourth lines just print out the buffer sizes for ports 0 and 1 of blk1. This is done after start() is called because the values are updated based on what is actually allocated to the block's buffers.</p>
<p>NOTES:</p>
<ol type="1">
<li>Buffer length assignment is done once at runtime (i.e., when run() or start() is called). So to set the max buffer lengths, the set_max_output_buffer calls must be done before this.</li>
<li>Once the flowgraph is started, the buffer lengths for a block are set and cannot be dynamically changed, even during a lock()/unlock(). If you need to change the buffer size, you will have to delete the block and rebuild it, and therefore must disconnect and reconnect the blocks.</li>
<li>This can affect throughput. Large buffers are designed to improve the efficiency and speed of the program at the expense of latency. Limiting the size of the buffer may decrease performance.</li>
<li>The real buffer size is actually based on a minimum granularity of the system. Typically, this is a page size, which is typically 4096 bytes. This means that any buffer size that is specified with this command will get rounded up to the nearest granularity (e.g., page size). When calling max_output_buffer(port) after the flowgraph is started, you will get how many items were actually allocated in the buffer, which may be different than what was initially specified.</li>
</ol>
<h1><a class="anchor" id="reconfigure"></a>
Reconfiguring Flowgraphs</h1>
<p>It is possible to reconfigure the flowgraph at runtime. The reconfiguration is meant for changes in the flowgraph structure, not individual parameter settings of the blocks. For example, changing the constant in a <a class="el" href="classgr_1_1blocks_1_1add__const__cc.html" title="output = input + constant ">gr::blocks::add_const_cc</a> block can be done while the flowgraph is running using the 'set_k(k)' method.</p>
<p>Reconfiguration is done by locking the flowgraph, which stops it from running and processing data, performing the reconfiguration, and then restarting the graph by unlocking it.</p>
<p>The following example code shows a graph that first adds two gr::analog::noise_source_c blocks and then replaces the gr::blocks::add_cc block with a gr::blocks::sub_cc block to then subtract the sources.</p>
<div class="fragment"><div class="line">from gnuradio <span class="keyword">import</span> gr, analog, blocks</div>
<div class="line"><span class="keyword">import</span> time</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>mytb(gr.top_block):</div>
<div class="line">    def __init__(self):</div>
<div class="line">        gr.top_block.__init__(self)</div>
<div class="line"></div>
<div class="line">        self.src0 = analog.noise_source_c(analog.GR_GAUSSIAN, 1)</div>
<div class="line">        self.src1 = analog.noise_source_c(analog.GR_GAUSSIAN, 1)</div>
<div class="line">        self.add  = blocks.add_cc()</div>
<div class="line">        self.sub  = blocks.sub_cc()</div>
<div class="line">        self.head = blocks.head(gr.sizeof_gr_complex, 1000000)</div>
<div class="line">        self.snk  = blocks.file_sink(gr.sizeof_gr_complex, &quot;output.32fc&quot;)</div>
<div class="line"></div>
<div class="line">        self.connect(self.src0, (self.add,0))</div>
<div class="line">        self.connect(self.src1, (self.add,1))</div>
<div class="line">        self.connect(self.add, self.head)</div>
<div class="line">        self.connect(self.head, self.snk)</div>
<div class="line"></div>
<div class="line">def main():</div>
<div class="line">    tb = mytb()</div>
<div class="line">    tb.start()</div>
<div class="line">    time.sleep(0.01)</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Stop flowgraph and disconnect the add block</span></div>
<div class="line"><span class="preprocessor"></span>    tb.lock()</div>
<div class="line">    tb.disconnect(tb.add, tb.head)</div>
<div class="line">    tb.disconnect(tb.src0, (tb.add,0))</div>
<div class="line">    tb.disconnect(tb.src1, (tb.add,1))</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Connect the sub block and restart</span></div>
<div class="line"><span class="preprocessor"></span>    tb.connect(tb.sub, tb.head)</div>
<div class="line">    tb.connect(tb.src0, (tb.sub,0))</div>
<div class="line">    tb.connect(tb.src1, (tb.sub,1))</div>
<div class="line">    tb.unlock()</div>
<div class="line"></div>
<div class="line">    tb.wait()</div>
<div class="line"></div>
<div class="line">if __name__ == &quot;__main__&quot;:</div>
<div class="line">    main()</div>
</div><!-- fragment --><p>During reconfiguration, the maximum noutput_items value can be changed either globally using the 'set_max_noutput_items(m)' on the gr_top_block object or locally using the 'set_max_noutput_items(m)' on any given block object.</p>
<p>A block also has a 'unset_max_noutput_items()' method that unsets the local max noutput_items value so that block reverts back to using the global value.</p>
<p>The following example expands the previous example but sets and resets the max noutput_items both locally and globally.</p>
<div class="fragment"><div class="line">from gnuradio <span class="keyword">import</span> gr, analog, blocks</div>
<div class="line"><span class="keyword">import</span> time</div>
<div class="line"></div>
<div class="line"><span class="keyword">class </span>mytb(gr.top_block):</div>
<div class="line">    def __init__(self):</div>
<div class="line">        gr.top_block.__init__(self)</div>
<div class="line"></div>
<div class="line">        self.src0 = analog.noise_source_c(analog.GR_GAUSSIAN, 1)</div>
<div class="line">        self.src1 = analog.noise_source_c(analog.GR_GAUSSIAN, 1)</div>
<div class="line">        self.add  = blocks.add_cc()</div>
<div class="line">        self.sub  = blocks.sub_cc()</div>
<div class="line">        self.head = blocks.head(gr.sizeof_gr_complex, 1000000)</div>
<div class="line">        self.snk  = blocks.file_sink(gr.sizeof_gr_complex, &quot;output.32fc&quot;)</div>
<div class="line"></div>
<div class="line">        self.connect(self.src0, (self.add,0))</div>
<div class="line">        self.connect(self.src1, (self.add,1))</div>
<div class="line">        self.connect(self.add, self.head)</div>
<div class="line">        self.connect(self.head, self.snk)</div>
<div class="line"></div>
<div class="line">def main():</div>
<div class="line"><span class="preprocessor">    # Start the gr_top_block after setting some max noutput_items.</span></div>
<div class="line"><span class="preprocessor"></span>    tb = mytb()</div>
<div class="line">    tb.src1.set_max_noutput_items(2000)</div>
<div class="line">    tb.start(100)</div>
<div class="line">    time.sleep(0.01)</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Stop flowgraph and disconnect the add block</span></div>
<div class="line"><span class="preprocessor"></span>    tb.lock()</div>
<div class="line"></div>
<div class="line">    tb.disconnect(tb.add, tb.head)</div>
<div class="line">    tb.disconnect(tb.src0, (tb.add,0))</div>
<div class="line">    tb.disconnect(tb.src1, (tb.add,1))</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Connect the sub block</span></div>
<div class="line"><span class="preprocessor"></span>    tb.connect(tb.sub, tb.head)</div>
<div class="line">    tb.connect(tb.src0, (tb.sub,0))</div>
<div class="line">    tb.connect(tb.src1, (tb.sub,1))</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">    # Set new max_noutput_items for the gr_top_block</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">    # and unset the local value for src1</span></div>
<div class="line"><span class="preprocessor"></span>    tb.set_max_noutput_items(1000)</div>
<div class="line">    tb.src1.unset_max_noutput_items()</div>
<div class="line">    tb.unlock()</div>
<div class="line"></div>
<div class="line">    tb.wait()</div>
<div class="line"></div>
<div class="line">if __name__ == &quot;__main__&quot;:</div>
<div class="line">    main()</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 </li>
  </ul>
</div>
</body>
</html>
